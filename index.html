<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ï¼’ï¼ã®è³ªå•æ€§æ ¼åˆ¤æ–­ï¼ˆéŸ³å£°ãƒ»ãƒ†ã‚­ã‚¹ãƒˆï¼‰æ€§æ ¼åˆ¤æ–­</title>
  <style>
    :root{
      --bg1:#f6fbff;
      --bg2:#fff7f0;
      --card:#ffffffcc;
      --text:#1a2b3c;
      --muted:#5c7288;
      --accent:#2b8cff;
      --accent2:#ff7a59;
      --ok:#1fbf75;
      --warn:#ffb020;
      --danger:#ff4d6d;
      --shadow: 0 12px 30px rgba(20,40,70,.10);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic", "Meiryo", sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 15% 10%, rgba(43,140,255,.16), transparent 60%),
        radial-gradient(900px 500px at 85% 15%, rgba(255,122,89,.14), transparent 55%),
        linear-gradient(140deg, var(--bg1), var(--bg2));
      min-height:100vh;
      display:flex;
      align-items:stretch;
      justify-content:center;
    }
    .wrap{
      width:min(1100px, 96vw);
      padding:22px 14px 40px;
      display:grid;
      gap:14px;
    }
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:16px 18px;
      background:var(--card);
      border:1px solid rgba(40,80,120,.10);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
    }
    .brand{
      display:flex; flex-direction:column; gap:4px;
    }
    .brand h1{
      margin:0;
      font-size:18px;
      letter-spacing:.02em;
    }
    .brand p{
      margin:0;
      color:var(--muted);
      font-size:12px;
    }
    .toggles{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .pill{
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      background:#ffffffaa;
      border:1px solid rgba(40,80,120,.12);
    }
    .pill label{font-size:12px;color:var(--muted)}
    .pill input[type="checkbox"]{transform: translateY(1px);}
    main{
      display:grid;
      grid-template-columns: 1.25fr .9fr;
      gap:14px;
    }
    @media (max-width: 920px){
      main{grid-template-columns:1fr}
    }
    .card{
      background:var(--card);
      border:1px solid rgba(40,80,120,.10);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 16px;
      border-bottom:1px solid rgba(40,80,120,.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .card .hd h2{
      margin:0;
      font-size:14px;
      letter-spacing:.02em;
      color:var(--muted);
    }
    .card .bd{ padding:16px; }
    .grid{
      display:grid; gap:12px;
    }
    .row{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .row > *{flex: 1 1 auto;}
    input[type="text"], input[type="number"], textarea, select{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(40,80,120,.18);
      background:#fff;
      color:var(--text);
      outline:none;
      box-shadow: 0 1px 0 rgba(0,0,0,.02);
    }
    textarea{min-height:96px; resize:vertical;}
    input:focus, textarea:focus, select:focus{
      border-color: rgba(43,140,255,.55);
      box-shadow: 0 0 0 4px rgba(43,140,255,.12);
    }
    .btns{display:flex; gap:10px; flex-wrap:wrap;}
    button{
      border:0;
      border-radius:14px;
      padding:11px 14px;
      font-weight:700;
      cursor:pointer;
      transition: transform .05s ease, filter .15s ease, box-shadow .15s ease;
      box-shadow: 0 10px 22px rgba(43,140,255,.16);
    }
    button:active{transform: translateY(1px);}
    .primary{
      background: linear-gradient(135deg, var(--accent), #61a8ff);
      color:white;
    }
    .secondary{
      background: linear-gradient(135deg, #ffffff, #f3f8ff);
      border:1px solid rgba(43,140,255,.22);
      color:var(--accent);
      box-shadow: none;
    }
    .danger{
      background: linear-gradient(135deg, var(--danger), #ff7b95);
      color:white;
      box-shadow: 0 10px 22px rgba(255,77,109,.16);
    }
    .ghost{
      background:transparent;
      border:1px dashed rgba(40,80,120,.25);
      color:var(--muted);
      box-shadow:none;
    }
    .hint{
      font-size:12px;
      color:var(--muted);
      line-height:1.5;
    }
    .progress{
      height:10px;
      background:rgba(40,80,120,.10);
      border-radius:999px;
      overflow:hidden;
    }
    .bar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--ok), var(--accent));
      border-radius:999px;
      transition: width .25s ease;
    }
    .chat{
      display:grid;
      gap:10px;
      max-height:520px;
      overflow:auto;
      padding-right:6px;
    }
    .bubble{
      border-radius:16px;
      padding:10px 12px;
      border:1px solid rgba(40,80,120,.10);
      background:#fff;
      box-shadow: 0 8px 18px rgba(20,40,70,.06);
      line-height:1.55;
      font-size:14px;
      word-break:break-word;
    }
    .me{
      background: linear-gradient(180deg, #ffffff, #f7fbff);
      border-color: rgba(43,140,255,.15);
    }
    .ai{
      background: linear-gradient(180deg, #ffffff, #fff7f2);
      border-color: rgba(255,122,89,.18);
    }
    .meta{
      display:flex;
      justify-content:space-between;
      font-size:11px;
      color:var(--muted);
      margin-top:6px;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      background: rgba(43,140,255,.10);
      color: var(--accent);
      border:1px solid rgba(43,140,255,.18);
      font-size:12px;
      font-weight:700;
    }
    .tag.orange{
      background: rgba(255,122,89,.10);
      color: var(--accent2);
      border-color: rgba(255,122,89,.18);
    }
    .twoCol{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width:520px){ .twoCol{grid-template-columns:1fr} }

    .resultGrid{
      display:grid;
      gap:12px;
    }
    .scoreRow{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
      padding:10px 12px;
      border-radius:14px;
      background:#fff;
      border:1px solid rgba(40,80,120,.10);
    }
    .scoreRow b{font-size:13px;}
    .scoreRow .s{
      font-variant-numeric: tabular-nums;
      font-size:13px;
      color:var(--muted);
    }
    .small{
      font-size:12px; color:var(--muted); line-height:1.55;
    }
    canvas{
      width:100%;
      height:auto;
      border-radius:16px;
      background: linear-gradient(180deg, #ffffff, #f9fbff);
      border:1px solid rgba(40,80,120,.10);
      box-shadow: 0 8px 18px rgba(20,40,70,.06);
    }
    .notice{
      padding:10px 12px;
      border-radius:14px;
      background: rgba(255,176,32,.12);
      border:1px solid rgba(255,176,32,.22);
      color:#7a4b00;
      font-size:12px;
      line-height:1.55;
    }
    .oknotice{
      padding:10px 12px;
      border-radius:14px;
      background: rgba(31,191,117,.10);
      border:1px solid rgba(31,191,117,.20);
      color:#0b5c35;
      font-size:12px;
      line-height:1.55;
    }
    .divider{
      height:1px; background:rgba(40,80,120,.10); margin:12px 0;
    }
  </style>

  <!-- PWA -->
  <meta name="theme-color" content="#2b8cff">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="æ€§æ ¼åˆ¤æ–­">
  <meta name="description" content="20ã®è³ªå•ã§æ€§æ ¼å‚¾å‘ã‚’å¯è¦–åŒ–ï¼ˆéŸ³å£°ãƒ»ãƒ†ã‚­ã‚¹ãƒˆï¼‰ã€‚ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã§ãã‚‹PWAç‰ˆã€‚">

</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <h1>ï¼’ï¼ã®è³ªå•æ€§æ ¼åˆ¤æ–­ï¼ˆéŸ³å£°ãƒ»ãƒ†ã‚­ã‚¹ãƒˆï¼‰æ€§æ ¼åˆ¤æ–­</h1>
        <p>ä¼šè©±ã®ã‚„ã‚Šå–ã‚Šã®å†…å®¹ã‹ã‚‰æ€§æ ¼ã‚’åˆ¤æ–­ã—ã¦ã€æ˜ã‚‹ãã‚·ãƒ³ãƒ—ãƒ«ã«ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã—ã¾ã™ã€‚</p>
      </div>
      <div class="toggles">
        <div class="pill">
          <label for="mode">å…¥åŠ›</label>
          <select id="mode" aria-label="å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰">
            <option value="text">ãƒ†ã‚­ã‚¹ãƒˆ</option>
            <option value="voice">éŸ³å£°</option>
          </select>
        </div>
        <div class="pill">
          <label><input id="speak" type="checkbox" checked /> éŸ³å£°ã§èª­ã¿ä¸Šã’</label>
        </div>
      </div>
    </header>

    <main>
      <!-- Left: Interview -->
      <section class="card">
        <div class="hd">
          <h2>è³ªå•ã‚»ãƒƒã‚·ãƒ§ãƒ³</h2>
          <span class="tag" id="statusTag">æº–å‚™ä¸­</span>
        </div>
        <div class="bd">
          <div class="grid">
            <div class="twoCol">
              <div>
                <label class="hint">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ï¼ˆå¿…é ˆï¼‰</label>
                <input id="nickname" type="text" placeholder="ä¾‹ï¼‰ãƒˆãƒ‹ãƒ¼" />
              </div>
              <div>
                <label class="hint">å¹´é½¢ï¼ˆå¿…é ˆï¼‰</label>
                <input id="age" type="number" min="0" max="120" placeholder="ä¾‹ï¼‰28" />
              </div>
            </div>

            <div class="notice" id="voiceNotice" style="display:none;">
              â€»éŸ³å£°å…¥åŠ›ã¯ãƒ–ãƒ©ã‚¦ã‚¶å¯¾å¿œãŒå¿…è¦ã§ã™ã€‚Chromeç³»ã§å‹•ä½œã—ã‚„ã™ã„ã§ã™ã€‚<br/>
              ãƒã‚¤ã‚¯è¨±å¯ãŒæ±‚ã‚ã‚‰ã‚ŒãŸã‚‰ã€Œè¨±å¯ã€ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚
            </div>

            <div class="oknotice" id="readyNotice">
              å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ã‚’é¸ã³ã€ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã¨å¹´é½¢ã‚’å…¥ã‚ŒãŸã‚‰ã€Œé–‹å§‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚<br/>
              é€”ä¸­ã§å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ã¯åˆ‡ã‚Šæ›¿ãˆã§ãã¾ã™ã€‚
            </div>

            <div class="progress" aria-label="é€²æ—">
              <div class="bar" id="progressBar"></div>
            </div>
            <div class="row" style="justify-content:space-between;">
              <div class="hint" id="progressText">0 / 20</div>
              <div class="hint" id="questionLabel">è³ªå•ï¼šâ€”</div>
            </div>

            <div class="chat" id="chat"></div>

            <div id="inputArea" class="grid">
              <textarea id="answerText" placeholder="ã“ã“ã«å›ç­”ã‚’å…¥åŠ›â€¦ï¼ˆçŸ­ãã¦ã‚‚OKï¼‰"></textarea>
              <div class="btns">
                <button class="primary" id="startBtn">é–‹å§‹</button>
                <button class="secondary" id="listenBtn" style="display:none;">ğŸ¤ éŒ²éŸ³é–‹å§‹</button>
                <button class="secondary" id="stopBtn" style="display:none;">â–  éŒ²éŸ³åœæ­¢</button>
                <button class="primary" id="sendBtn" disabled>å›ç­”ã‚’é€ä¿¡</button>
                <button class="ghost" id="skipBtn" disabled>ã‚¹ã‚­ãƒƒãƒ—</button>
                <button class="danger" id="resetBtn">ãƒªã‚»ãƒƒãƒˆ</button>
              </div>
              <div class="hint">
                ã‚³ãƒ„ï¼šæ€ã„ã¤ã„ãŸã“ã¨ã‚’ç´ ç›´ã«ã€‚æ­£è§£/ä¸æ­£è§£ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚<br/>
                â€»å ã„ãƒ»çµ±è¨ˆå­¦ï¼ˆèª•ç”Ÿæ—¥ãªã©ï¼‰ã¯ä½¿ã‚ãšã€å›ç­”å†…å®¹ã ã‘ã§åˆ¤æ–­ã—ã¾ã™ã€‚
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Right: Results -->
      <aside class="card">
        <div class="hd">
          <h2>ç·åˆè©•ä¾¡ï¼ˆ20å•çµ‚äº†å¾Œï¼‰</h2>
          <span class="tag orange" id="resultTag">æœªä½œæˆ</span>
        </div>
        <div class="bd">
          <div class="grid">
            <canvas id="radar" width="620" height="520" aria-label="ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ"></canvas>

            <div class="resultGrid" id="resultArea">
              <div class="small">20å•å›ç­”ã™ã‚‹ã¨ã€7é …ç›®ã®è©•ä¾¡ï¼ˆå„100æ–‡å­—ä»¥å†…ï¼‰ã¨ã‚¢ãƒ‰ãƒã‚¤ã‚¹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
            </div>
          </div>
        </div>
      </aside>
    </main>
  </div>

<script>
(() => {
  // -----------------------------
  // 20 Questions (important points included)
  // -----------------------------
  const QUESTIONS = [
    "æœ€è¿‘ã€å°‘ã—é ‘å¼µã£ãŸã“ã¨ã¯ä½•ï¼Ÿã©ã‚“ãªå·¥å¤«ã‚’ã—ãŸï¼Ÿ",
    "æ±ºæ–­ã™ã‚‹ã¨ãã€ã¾ãšä½•ã‚’å„ªå…ˆã™ã‚‹ï¼Ÿï¼ˆæ™‚é–“ãƒ»å®‰å¿ƒãƒ»çµæœãƒ»æ¥½ã—ã•ãªã©ï¼‰",
    "ã†ã¾ãã„ã‹ãªã‹ã£ãŸæ™‚ã€æœ€åˆã«ã©ã†ç«‹ã¦ç›´ã™ï¼Ÿ",
    "æ–°ã—ã„ã“ã¨ã‚’å§‹ã‚ã‚‹æ™‚ã€ãƒ¯ã‚¯ãƒ¯ã‚¯ã¨ä¸å®‰ã®å‰²åˆã¯ï¼Ÿç†ç”±ã‚‚å°‘ã—ã€‚",
    "äººã¨è©±ã™ã¨ãã€èãæ´¾ï¼Ÿè©±ã™æ´¾ï¼Ÿãã®ç†ç”±ã¯ï¼Ÿ",
    "è¤’ã‚ã‚‰ã‚ŒãŸã‚‰ã©ã†æ„Ÿã˜ã‚‹ï¼Ÿã©ã†è¿”ã™ã“ã¨ãŒå¤šã„ï¼Ÿ",
    "å¿™ã—ã„ã¨ãã€å¿ƒã®ä½™è£•ã‚’ä½œã‚‹æ–¹æ³•ã¯ï¼Ÿ",
    "ç›®æ¨™ã‚’ç«‹ã¦ã‚‹ãªã‚‰ã€æœŸé™ã¯å¿…è¦ï¼Ÿãã‚Œã¨ã‚‚æ°—åˆ†ï¼Ÿ",
    "ãŠé‡‘ã®ä½¿ã„æ–¹ã§å¤§äº‹ã«ã—ã¦ã„ã‚‹ã“ã¨ã¯ï¼Ÿï¼ˆçµŒé¨“ãƒ»å®‰å¿ƒãƒ»æŠ•è³‡ãƒ»æ¥½ã—ã•ï¼‰",
    "ä»•äº‹ï¼ˆoræ´»å‹•ï¼‰ã§ã€Œã“ã‚Œã ã‘ã¯è­²ã‚Œãªã„ã€ã¨æ€ã†ä¾¡å€¤è¦³ã¯ï¼Ÿ",
    "ãƒãƒ¼ãƒ ã§å‹•ãã¨ãã€ã‚ãªãŸã¯ã©ã‚“ãªå½¹å‰²ã«ãªã‚Šã‚„ã™ã„ï¼Ÿ",
    "å¤±æ•—ã‚’äººã«è©±ã™ã¨ãã€ã©ã‚“ãªä¼ãˆæ–¹ã‚’ã™ã‚‹ï¼Ÿ",
    "æ‹æ„›ï¼ˆã¾ãŸã¯è¦ªã—ã„é–¢ä¿‚ï¼‰ã§å¤§äº‹ã«ã—ãŸã„ã“ã¨ã¯ï¼Ÿ",
    "ç›¸æ‰‹ã«ä¸æº€ãŒã‚ã‚‹ã¨ãã€ã©ã†ä¼ãˆã‚‹ã‚¿ã‚¤ãƒ—ï¼Ÿ",
    "å¥½ãã«ãªã£ãŸã‚‰ã€ç©æ¥µçš„ï¼Ÿæ…é‡ï¼Ÿãã®ç†ç”±ã¯ï¼Ÿ",
    "ã‚¹ãƒˆãƒ¬ã‚¹ã®ã‚µã‚¤ãƒ³ã¯ã©ã“ã«å‡ºã‚‹ï¼Ÿï¼ˆä½“ãƒ»æ°—åˆ†ãƒ»è¡Œå‹•ï¼‰",
    "è½ã¡è¾¼ã‚“ã ã¨ãã€å›å¾©ã®ã‚¹ã‚¤ãƒƒãƒã¯ä½•ï¼Ÿ",
    "ã‚ãªãŸã®å¼·ã¿ã‚’1ã¤ã ã‘æŒ™ã’ã‚‹ãªã‚‰ï¼Ÿå…·ä½“ä¾‹ã‚‚å°‘ã—ã€‚",
    "é€†ã«ã€ç›´ã—ãŸã„ã‚¯ã‚»ï¼ˆèª²é¡Œï¼‰ã¯ï¼Ÿä»Šã©ã†å·¥å¤«ã—ã¦ã‚‹ï¼Ÿ",
    "ã“ã®å…ˆ3ãƒ¶æœˆã§ã€å°‘ã—ã§ã‚‚è‰¯ãã—ãŸã„ã“ã¨ã¯ä½•ï¼Ÿæœ€åˆã®ä¸€æ­©ã¯ï¼Ÿ"
  ];

  // 7 Traits
  const TRAITS = [
    { key:"motivation",   label:"ã‚„ã‚‹æ°—" },
    { key:"business",     label:"ãƒ“ã‚¸ãƒã‚¹" },
    { key:"love",         label:"æ‹æ„›" },
    { key:"communication",label:"ã‚³ãƒŸãƒ¥åŠ›" },
    { key:"creativity",   label:"å‰µé€ æ€§" },
    { key:"resilience",   label:"å›å¾©åŠ›" },
    { key:"balance",      label:"ãƒãƒ©ãƒ³ã‚¹" },
  ];

  // Keyword sets for light scoring (Japanese)
  const KW = {
    positive: ["æ¥½ã—ã„","å¬‰ã—ã„","ãƒ¯ã‚¯ãƒ¯ã‚¯","æˆé•·","æŒ‘æˆ¦","ã‚„ã£ã¦ã¿ã‚‹","ã§ãã‚‹","æ”¹å–„","å·¥å¤«","å‰å‘ã","å­¦ã¶","ç¶šã‘ã‚‹","ç¿’æ…£"],
    negative: ["ç„¡ç†","ã ã‚","å«Œ","ç–²ã‚Œ","ä¸å®‰","æ€–ã„","é¢å€’","ã‚ãã‚‰ã‚","ã©ã†ã§ã‚‚","ã§ããªã„","ç„¡æ°—åŠ›","ã‚¤ãƒ©ã‚¤ãƒ©"],
    goal: ["ç›®æ¨™","æœŸé™","è¨ˆç”»","å„ªå…ˆ","æ®µå–ã‚Š","ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«","æˆæœ","çµæœ","KPI","é”æˆ","åŠ¹ç‡","æ•´ç†"],
    people: ["ç›¸æ‰‹","äºº","å‹é”","å®¶æ—","ä»²é–“","ãƒãƒ¼ãƒ ","èã","ä¼ãˆã‚‹","å…±æ„Ÿ","ç›¸è«‡","å”åŠ›","é…æ…®"],
    love: ["æ‹","å¥½ã","ä»˜ãåˆ","çµå©š","ãƒ‡ãƒ¼ãƒˆ","é€£çµ¡","è·é›¢","ä¿¡é ¼","å®‰å¿ƒ","å°Šé‡","æŸç¸›","å«‰å¦¬"],
    money: ["ãŠé‡‘","æŠ•è³‡","è²¯é‡‘","ç¯€ç´„","è²·ã†","ä½¿ã†","ä¾¡å€¤","çµŒé¨“","å®‰å¿ƒ"],
    create: ["ã‚¢ã‚¤ãƒ‡ã‚¢","ç™ºæƒ³","ä½œã‚‹","è©¦ã™","æ–°ã—ã„","å·¥å¤«","æ”¹å–„","å¤‰ãˆã‚‹","é¢ç™½ã„"],
    recover: ["ä¼‘ã‚€","åˆ‡ã‚Šæ›¿ãˆ","æ•£æ­©","ç¡çœ ","é‹å‹•","æ·±å‘¼å¸","ç›¸è«‡","æ›¸ã","æ³£ã","æ•´ãˆã‚‹","å›å¾©"]
  };

  // Aizuuchi + simple impression templates
  const AIZUCHI = ["ã†ã‚“ã†ã‚“ã€‚","ãªã‚‹ã»ã©ï¼","ã„ã„ã­ã€‚","ã‚ã‹ã‚‹ã€‚","ãŸã—ã‹ã«ã€‚","ãã‚Œå¤§äº‹ã€‚","é¢ç™½ã„è¦–ç‚¹ã ã­ã€‚","ã„ã„æ„Ÿã˜ã€‚"];
  const IMPRESS = [
    "ä»Šã®è¨€ã„æ–¹ã€èª å®Ÿã•ãŒå‡ºã¦ã‚‹ã€‚",
    "ã¡ã‚ƒã‚“ã¨è‡ªåˆ†ã®è»¸ãŒã‚ã‚‹ã­ã€‚",
    "è¦–ç‚¹ãŒå…·ä½“çš„ã§ã‚¤ãƒ¡ãƒ¼ã‚¸ã—ã‚„ã™ã„ã€‚",
    "æ°—æŒã¡ã®æ•´ç†ãŒä¸Šæ‰‹ãã†ã€‚",
    "ãƒãƒ©ãƒ³ã‚¹æ„Ÿè¦šãŒã‚ã‚‹ç­”ãˆæ–¹ã ã­ã€‚",
    "è¡Œå‹•ã«è½ã¨ã›ã¦ã‚‹ã®ãŒå¼·ã„ã€‚",
    "ç›¸æ‰‹ç›®ç·šã‚‚å…¥ã£ã¦ã¦ç´ æ•µã€‚",
    "ä¼¸ã³ã—ã‚ã‚’è‡ªè¦šã—ã¦ã‚‹ã®ãŒè‰¯ã„ã€‚"
  ];

  // -----------------------------
  // State
  // -----------------------------
  const state = {
    started: false,
    finished: false,
    qIndex: 0,
    answers: [],
    nickname: "",
    age: null,
    inputMode: "text",
    speak: true,
    recognizing: false
  };

  // -----------------------------
  // Elements
  // -----------------------------
  const el = {
    mode: document.getElementById("mode"),
    speak: document.getElementById("speak"),
    nickname: document.getElementById("nickname"),
    age: document.getElementById("age"),
    startBtn: document.getElementById("startBtn"),
    sendBtn: document.getElementById("sendBtn"),
    skipBtn: document.getElementById("skipBtn"),
    resetBtn: document.getElementById("resetBtn"),
    listenBtn: document.getElementById("listenBtn"),
    stopBtn: document.getElementById("stopBtn"),
    answerText: document.getElementById("answerText"),
    chat: document.getElementById("chat"),
    progressBar: document.getElementById("progressBar"),
    progressText: document.getElementById("progressText"),
    questionLabel: document.getElementById("questionLabel"),
    statusTag: document.getElementById("statusTag"),
    radar: document.getElementById("radar"),
    resultArea: document.getElementById("resultArea"),
    resultTag: document.getElementById("resultTag"),
    voiceNotice: document.getElementById("voiceNotice"),
    readyNotice: document.getElementById("readyNotice"),
  };

  // -----------------------------
  // Voice (Web Speech API)
  // -----------------------------
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  let recognition = null;

  function canUseVoice(){
    return !!SpeechRecognition;
  }

  function initRecognition(){
    if(!canUseVoice()) return null;
    const r = new SpeechRecognition();
    r.lang = "ja-JP";
    r.interimResults = true;
    r.continuous = true;

    r.onstart = () => {
      state.recognizing = true;
      updateVoiceButtons();
      addSystemBubble("ğŸ¤ éŒ²éŸ³ä¸­â€¦ è©±ã—ãŸå†…å®¹ãŒå…¥åŠ›æ¬„ã«åæ˜ ã•ã‚Œã¾ã™ã€‚");
    };

    r.onend = () => {
      state.recognizing = false;
      updateVoiceButtons();
    };

    r.onerror = (e) => {
      state.recognizing = false;
      updateVoiceButtons();
      addSystemBubble("éŸ³å£°å…¥åŠ›ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒã‚¤ã‚¯è¨±å¯ã‚„ãƒ–ãƒ©ã‚¦ã‚¶å¯¾å¿œã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
      console.warn(e);
    };

    r.onresult = (event) => {
      let finalText = "";
      let interimText = "";
      for(let i=event.resultIndex; i<event.results.length; i++){
        const txt = event.results[i][0].transcript;
        if(event.results[i].isFinal) finalText += txt;
        else interimText += txt;
      }
      const current = el.answerText.value.trim();
      const merged = (current ? current + " " : "") + finalText + interimText;
      el.answerText.value = merged.trim();
      updateSendEnabled();
    };

    return r;
  }

  function startListening(){
    if(!recognition) recognition = initRecognition();
    if(!recognition){
      addSystemBubble("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯éŸ³å£°å…¥åŠ›ãŒä½¿ãˆãªã„ã¿ãŸã„ã§ã™ã€‚ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã§é€²ã‚ã‚ˆã†ã€‚");
      return;
    }
    try{ recognition.start(); } catch(_) {}
  }

  function stopListening(){
    if(recognition && state.recognizing){
      recognition.stop();
    }
  }

  function speak(text){
    if(!state.speak) return;
    if(!("speechSynthesis" in window)) return;
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = "ja-JP";
    u.rate = 1.02;
    u.pitch = 1.05;
    window.speechSynthesis.speak(u);
  }

  // -----------------------------
  // UI Helpers
  // -----------------------------
  function nowTime(){
    const d = new Date();
    return d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
  }
  function addBubble(text, who="ai"){
    const b = document.createElement("div");
    b.className = "bubble " + (who==="me" ? "me" : (who==="sys" ? "ai" : "ai"));
    b.innerHTML = text.replace(/\n/g,"<br/>");
    const meta = document.createElement("div");
    meta.className = "meta";
    meta.innerHTML = `<span>${who==="me" ? "ã‚ãªãŸ" : (who==="sys" ? "ã‚·ã‚¹ãƒ†ãƒ " : "ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ")}</span><span>${nowTime()}</span>`;
    b.appendChild(meta);
    el.chat.appendChild(b);
    el.chat.scrollTop = el.chat.scrollHeight;
  }
  function addSystemBubble(text){ addBubble(text, "sys"); }

  function setStatus(text, kind="normal"){
    el.statusTag.textContent = text;
    el.statusTag.style.borderColor = kind==="ok" ? "rgba(31,191,117,.25)" : (kind==="warn" ? "rgba(255,176,32,.30)" : "rgba(43,140,255,.22)");
    el.statusTag.style.background = kind==="ok" ? "rgba(31,191,117,.12)" : (kind==="warn" ? "rgba(255,176,32,.12)" : "rgba(43,140,255,.10)");
    el.statusTag.style.color = kind==="ok" ? "#0b5c35" : (kind==="warn" ? "#7a4b00" : "var(--accent)");
  }

  function updateProgress(){
    const done = Math.min(state.qIndex, 20);
    const pct = (done / 20) * 100;
    el.progressBar.style.width = pct + "%";
    el.progressText.textContent = `${done} / 20`;
    el.questionLabel.textContent = state.started && !state.finished ? `è³ªå•ï¼š${state.qIndex+1}` : "è³ªå•ï¼šâ€”";
  }

  function updateSendEnabled(){
    const ok = state.started && !state.finished && el.answerText.value.trim().length > 0;
    el.sendBtn.disabled = !ok;
  }

  function updateControls(){
    el.skipBtn.disabled = !(state.started && !state.finished);
    updateSendEnabled();
  }

  function updateVoiceButtons(){
    const voice = state.inputMode === "voice";
    el.voiceNotice.style.display = voice ? "block" : "none";
    el.listenBtn.style.display = voice ? "inline-flex" : "none";
    el.stopBtn.style.display = voice ? "inline-flex" : "none";
    el.listenBtn.disabled = state.recognizing;
    el.stopBtn.disabled = !state.recognizing;
  }

  // -----------------------------
  // Scoring
  // -----------------------------
  function countHits(text, list){
    let c = 0;
    for(const w of list){
      if(text.includes(w)) c++;
    }
    return c;
  }

  function normalizeScore(x){ return Math.max(0, Math.min(100, Math.round(x))); }

  function computeTraitScores(answers){
    // Start at 50 and adjust by keywords + answer richness
    const joined = answers.join(" ");
    const lenBonus = Math.min(12, Math.floor(joined.length / 120)); // 0..12

    const pos = countHits(joined, KW.positive);
    const neg = countHits(joined, KW.negative);
    const goal = countHits(joined, KW.goal);
    const ppl  = countHits(joined, KW.people);
    const lov  = countHits(joined, KW.love);
    const mon  = countHits(joined, KW.money);
    const cre  = countHits(joined, KW.create);
    const rec  = countHits(joined, KW.recover);

    // Question-specific nudges (light)
    const byQ = (idx) => (answers[idx] || "");
    const qGoal = countHits(byQ(7) + " " + byQ(19), KW.goal);
    const qBiz  = countHits(byQ(8) + " " + byQ(9) + " " + byQ(10), KW.goal.concat(KW.money));
    const qLove = countHits(byQ(12) + " " + byQ(13) + " " + byQ(14), KW.love.concat(KW.people));
    const qRes  = countHits(byQ(2) + " " + byQ(16) + " " + byQ(17), KW.recover.concat(["ç«‹ã¦ç›´","åˆ‡ã‚Šæ›¿","å¾©æ´»","å¯","ä¼‘"]));
    const qCom  = countHits(byQ(4) + " " + byQ(5) + " " + byQ(11) + " " + byQ(13), KW.people);
    const qCre  = countHits(byQ(0) + " " + byQ(3) + " " + byQ(18), KW.create.concat(["å·¥å¤«","æ”¹å–„","è©¦"]));
    const qBal  = countHits(byQ(6) + " " + byQ(15), ["ä½™è£•","æ•´","ä¼‘","ç¡çœ ","é‹å‹•","æ•£æ­©","åˆ‡ã‚Šæ›¿","å¢ƒç•Œ","ã»ã©ã»ã©"]);

    const scores = {};
    scores.motivation    = normalizeScore(50 + lenBonus + pos*3 - neg*3 + qGoal*6 + goal*2);
    scores.business      = normalizeScore(50 + lenBonus + goal*4 + mon*3 + qBiz*6 - neg*2);
    scores.love          = normalizeScore(50 + lenBonus + ppl*2 + lov*5 + qLove*6 - neg*2);
    scores.communication = normalizeScore(50 + lenBonus + ppl*5 + qCom*5 + pos*1 - neg*2);
    scores.creativity    = normalizeScore(50 + lenBonus + cre*6 + qCre*6 + pos*1);
    scores.resilience    = normalizeScore(50 + lenBonus + rec*6 + qRes*6 - neg*1);
    scores.balance       = normalizeScore(50 + lenBonus + qBal*8 + rec*2 - neg*2 + pos*1);

    // keep within [20, 95] if extremely sparse
    const totalLen = joined.replace(/\s/g,"").length;
    if(totalLen < 40){
      for(const k in scores) scores[k] = normalizeScore(45 + lenBonus);
    }
    return scores;
  }

  function evaluationText(label, score){
    // <= 100 chars in Japanese (hard-limit by intent)
    if(score >= 85) return `${label}ã¯ã‹ãªã‚Šå¼·ã„ã€‚è‡ªåˆ†ã®å‹ã‚’æŒã¡ã€ä¼¸ã°ã—æ–¹ã‚‚åˆ†ã‹ã£ã¦ã„ã‚‹ã‚¿ã‚¤ãƒ—ã€‚`;
    if(score >= 70) return `${label}ã¯å®‰å®šã—ã¦é«˜ã‚ã€‚èª¿å­ã®æ³¢ã‚’å°ã•ãã™ã‚‹ã¨ã•ã‚‰ã«ä¼¸ã³ã‚‹ã€‚`;
    if(score >= 55) return `${label}ã¯æ¨™æº–ã€œã‚„ã‚„å¼·ã‚ã€‚å ´é¢ã«å¿œã˜ã¦å‡ºã—åˆ†ã‘ã§ãã‚‹ã€‚`;
    if(score >= 40) return `${label}ã¯ä¼¸ã³ã—ã‚å¤§ã€‚å°ã•ãè©¦ã—ã¦æˆåŠŸä½“é¨“ã‚’å¢—ã‚„ã™ã¨è‰¯ã„ã€‚`;
    return `${label}ã¯ä»Šã¯æ§ãˆã‚ã€‚è² æ‹…ã‚’æ¸›ã‚‰ã—ã€1ã¤ã ã‘ç¶šã‘ã‚‹ç¿’æ…£ãŒéµã€‚`;
  }

  function adviceText(key, score){
    // Advice can be longer, but keep it readable and concrete
    const base = {
      motivation: [
        "ã€Œæœ€åˆã®ä¸€æ­©ã€ã‚’5åˆ†ã§çµ‚ã‚ã‚‹å½¢ã«åˆ†è§£ã—ã‚ˆã†ã€‚",
        "ã‚„ã‚‹æ°—ã¯å¾Œã‹ã‚‰æ¥ã‚‹ã‚¿ã‚¤ãƒ—ã€‚ç€æ‰‹ã®ãƒãƒ¼ãƒ‰ãƒ«ã‚’ä¸‹ã’ã¦OKã€‚",
        "è¨˜éŒ²ï¼ˆãƒã‚§ãƒƒã‚¯ï¼‰ã‚’ä»˜ã‘ã‚‹ã¨ç¶™ç¶šãŒä¸€æ°—ã«æ¥½ã«ãªã‚‹ã€‚"
      ],
      business: [
        "ä¾¡å€¤è¦³ï¼ˆè­²ã‚Œãªã„è»¸ï¼‰ã‚’è¨€èªåŒ–ã—ã¦ã€åˆ¤æ–­ã®è¿·ã„ã‚’æ¸›ã‚‰ãã†ã€‚",
        "æ®µå–ã‚Šã¯ãƒ†ãƒ³ãƒ—ãƒ¬åŒ–ãŒåŠ¹ãã€‚æ¯å›ã®ã‚¼ãƒ­ã‹ã‚‰ã‚’æ¸›ã‚‰ã™ã€‚",
        "æˆæœã¯ã€é‡Ã—è³ªÃ—ç¶™ç¶šã€ã€‚ã¾ãšé‡ã‚’å°ã•ãç©ã‚€ã®ãŒå¼·ã„ã€‚"
      ],
      love: [
        "å¤§äº‹ã«ã—ãŸã„æ¡ä»¶ã‚’3ã¤ã«çµã£ã¦ã€ä¼ãˆæ–¹ã‚’æŸ”ã‚‰ã‹ãã™ã‚‹ã¨â—ã€‚",
        "ä¸æº€ã¯â€œäº‹å®Ÿâ†’æ°—æŒã¡â†’å¸Œæœ›â€ã®é †ã§è©±ã™ã¨æ‘©æ“¦ãŒæ¸›ã‚‹ã€‚",
        "è·é›¢æ„Ÿã®åˆæ„ãŒéµã€‚é€£çµ¡é »åº¦ã‚„ä¸€äººæ™‚é–“ã‚’å…ˆã«è©±ãã†ã€‚"
      ],
      communication: [
        "ç›¸ã¥ã¡ï¼‹è¦ç´„ï¼ˆã¤ã¾ã‚Šã€œã ã­ï¼‰ã‚’å…¥ã‚Œã‚‹ã¨ä¿¡é ¼ãŒä¸ŠãŒã‚‹ã€‚",
        "è³ªå•ã¯ã€ãªãœã€ã‚ˆã‚Šã€ã©ã†ã—ãŸã„ï¼Ÿã€ãŒå‰å‘ãã«ãªã‚Šã‚„ã™ã„ã€‚",
        "è¨€ã„ã«ãã„è©±ã¯çŸ­ããƒ»å…·ä½“çš„ã«ãƒ»çµè«–ã‹ã‚‰ãŒå¼·ã„ã€‚"
      ],
      creativity: [
        "ã‚¢ã‚¤ãƒ‡ã‚¢ã¯â€œæœªå®Œæˆã®ã¾ã¾ãƒ¡ãƒ¢â€ãŒæœ€å¼·ã€‚è©•ä¾¡ã¯å¾Œã§OKã€‚",
        "æœˆ1ã§ã€æ–°ã—ã„ä½“é¨“ã€ã‚’å…¥ã‚Œã‚‹ã¨ç™ºæƒ³ã®ææ–™ãŒå¢—ãˆã‚‹ã€‚",
        "å°ã•ãè©¦ã™â†’å­¦ã¶â†’æ”¹å–„ã€ã®ãƒ«ãƒ¼ãƒ—ã‚’é€Ÿãå›ãã†ã€‚"
      ],
      resilience: [
        "å›å¾©ã‚¹ã‚¤ãƒƒãƒï¼ˆç¡çœ /æ•£æ­©/ç›¸è«‡ãªã©ï¼‰ã‚’å›ºå®šã®å„€å¼ã«ã—ã‚ˆã†ã€‚",
        "è½ã¡è¾¼ã¿ã¯â€œä½“â†’ç’°å¢ƒâ†’æ€è€ƒâ€ã®é †ã«æ•´ãˆã‚‹ã¨æˆ»ã‚Šã‚„ã™ã„ã€‚",
        "è‡ªåˆ†è²¬ã‚ã®è¨€è‘‰ã‚’ã€æ¬¡ã®ä¸€æ‰‹ã®è¨€è‘‰ã«ç½®ãæ›ãˆã‚‹ã¨å¼·ã„ã€‚"
      ],
      balance: [
        "å¿™ã—ã„æ—¥ã¯ã€ã‚„ã‚‰ãªã„ãƒªã‚¹ãƒˆã€ã‚’å…ˆã«æ±ºã‚ã‚‹ã¨å¿ƒãŒå®ˆã‚Œã‚‹ã€‚",
        "ä¼‘ã‚€ã®ã‚‚äºˆå®šã«å…¥ã‚Œã‚‹ã€‚å›å¾©ã¯ã‚¿ã‚¹ã‚¯ã®ä¸€éƒ¨ã€‚",
        "å¢ƒç•Œç·šï¼ˆä»•äº‹/ç§ç”¨ï¼‰ã‚’æ™‚é–“ã§åŒºåˆ‡ã‚‹ã¨å®‰å®šã™ã‚‹ã€‚"
      ],
    };

    const picks = base[key] || ["å°ã•ãè©¦ã—ã¦ã€åˆã†ã‚„ã‚Šæ–¹ã‚’è¦‹ã¤ã‘ã‚ˆã†ã€‚"];
    if(score >= 75) return "å¼·ã¿ã‚’æ­¦å™¨ã«ã™ã‚‹æ™‚æœŸï¼š" + picks[1];
    if(score >= 55) return "ä¼¸ã°ã—æ–¹ï¼š" + picks[0];
    return "ç«‹ã¦ç›´ã—ã®ã‚³ãƒ„ï¼š" + picks[2];
  }

  function randomPick(arr){
    return arr[Math.floor(Math.random()*arr.length)];
  }

  function shortImpression(answer){
    // Simple impression based on length + keywords
    const t = answer.trim();
    const pos = countHits(t, KW.positive);
    const neg = countHits(t, KW.negative);
    const goal = countHits(t, KW.goal);
    const ppl = countHits(t, KW.people);
    if(t.length >= 70 && (goal + ppl) >= 1) return "å…·ä½“çš„ã§ã€èª¬å¾—åŠ›ãŒã‚ã‚‹ç­”ãˆã ã­ã€‚";
    if(pos >= 2) return "å‰å‘ãã•ãŒä¼ã‚ã£ã¦ãã‚‹ã‚ˆã€‚";
    if(neg >= 2) return "æ­£ç›´ã«è¨€ãˆã‚‹ã®ãŒå¼·ã¿ã€‚ä»Šã®çŠ¶æ…‹ã‚’æŠŠæ¡ã§ãã¦ã‚‹ã€‚";
    if(goal >= 1) return "è€ƒãˆæ–¹ãŒæ•´ç†ã•ã‚Œã¦ã„ã¦ã€è¡Œå‹•ã«ç¹‹ãŒã‚Šã‚„ã™ãã†ã€‚";
    if(ppl >= 1) return "ç›¸æ‰‹ç›®ç·šãŒå…¥ã£ã¦ã„ã¦ã€ã‚„ã•ã—ã„ç­”ãˆæ–¹ã ã­ã€‚";
    return randomPick(IMPRESS);
  }

  // -----------------------------
  // Radar Chart (no libraries)
  // -----------------------------
  function drawRadar(scores){
    const ctx = el.radar.getContext("2d");
    const W = el.radar.width, H = el.radar.height;
    ctx.clearRect(0,0,W,H);

    // layout
    const cx = W/2, cy = H/2 + 10;
    const radius = Math.min(W, H) * 0.34;
    const rings = 5;

    // soft grid
    ctx.save();
    ctx.translate(cx, cy);

    // background rings
    ctx.lineWidth = 1;
    ctx.strokeStyle = "rgba(40,80,120,.18)";
    for(let r=1; r<=rings; r++){
      const rr = radius * (r / rings);
      polygon(ctx, TRAITS.length, rr, -Math.PI/2);
      ctx.stroke();
    }

    // axes + labels
    ctx.strokeStyle = "rgba(40,80,120,.22)";
    ctx.fillStyle = "rgba(26,43,60,.92)";
    ctx.font = "13px ui-sans-serif, system-ui, -apple-system, 'Noto Sans JP', sans-serif";
    for(let i=0; i<TRAITS.length; i++){
      const ang = -Math.PI/2 + i*(2*Math.PI/TRAITS.length);
      const x = Math.cos(ang)*radius;
      const y = Math.sin(ang)*radius;
      ctx.beginPath();
      ctx.moveTo(0,0);
      ctx.lineTo(x,y);
      ctx.stroke();

      // label position
      const lx = Math.cos(ang)*(radius + 28);
      const ly = Math.sin(ang)*(radius + 28);
      const text = TRAITS[i].label;
      const align = (Math.cos(ang) > 0.25) ? "left" : (Math.cos(ang) < -0.25) ? "right" : "center";
      ctx.textAlign = align;
      ctx.textBaseline = "middle";
      ctx.fillText(text, lx, ly);
    }

    // data polygon
    const pts = [];
    for(let i=0;i<TRAITS.length;i++){
      const key = TRAITS[i].key;
      const v = (scores[key] ?? 50) / 100; // 0..1
      const ang = -Math.PI/2 + i*(2*Math.PI/TRAITS.length);
      pts.push([Math.cos(ang)*radius*v, Math.sin(ang)*radius*v]);
    }

    // fill
    ctx.beginPath();
    ctx.moveTo(pts[0][0], pts[0][1]);
    for(let i=1;i<pts.length;i++) ctx.lineTo(pts[i][0], pts[i][1]);
    ctx.closePath();
    ctx.fillStyle = "rgba(43,140,255,.18)";
    ctx.fill();
    ctx.strokeStyle = "rgba(43,140,255,.85)";
    ctx.lineWidth = 2;
    ctx.stroke();

    // points
    ctx.fillStyle = "rgba(255,122,89,.90)";
    for(const [x,y] of pts){
      ctx.beginPath();
      ctx.arc(x,y,4,0,Math.PI*2);
      ctx.fill();
    }

    // title
    ctx.textAlign = "center";
    ctx.fillStyle = "rgba(92,114,136,.95)";
    ctx.font = "12px ui-sans-serif, system-ui, -apple-system, 'Noto Sans JP', sans-serif";
    ctx.fillText("7é …ç›®ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆï¼ˆ0ã€œ100ï¼‰", 0, -radius - 46);

    ctx.restore();
  }

  function polygon(ctx, n, r, startAng){
    ctx.beginPath();
    for(let i=0;i<n;i++){
      const a = startAng + i*(2*Math.PI/n);
      const x = Math.cos(a)*r;
      const y = Math.sin(a)*r;
      if(i===0) ctx.moveTo(x,y);
      else ctx.lineTo(x,y);
    }
    ctx.closePath();
  }

  // -----------------------------
  // Flow
  // -----------------------------
  function validateProfile(){
    const nick = el.nickname.value.trim();
    const age = Number(el.age.value);
    if(!nick) return { ok:false, msg:"ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥ã‚Œã¦ã­ã€‚" };
    if(!Number.isFinite(age) || age <= 0) return { ok:false, msg:"å¹´é½¢ã‚’æ•°å­—ã§å…¥ã‚Œã¦ã­ã€‚" };
    return { ok:true, nick, age };
  }

  function askCurrentQuestion(){
    const q = QUESTIONS[state.qIndex];
    addBubble(`Q${state.qIndex+1}. ${q}`, "ai");
    speak(`è³ªå•${state.qIndex+1}ã€‚${q}`);
    el.answerText.value = "";
    updateSendEnabled();
    updateProgress();
    setStatus(`è³ªå• ${state.qIndex+1} / 20`, "normal");
  }

  function startSession(){
    if(state.started) return;
    const v = validateProfile();
    if(!v.ok){
      addSystemBubble(v.msg);
      speak(v.msg);
      return;
    }
    state.nickname = v.nick;
    state.age = v.age;

    state.started = true;
    state.finished = false;
    state.qIndex = 0;
    state.answers = [];

    el.readyNotice.style.display = "none";
    setStatus("é–‹å§‹ã—ã¾ã—ãŸ", "ok");

    addBubble(`ã“ã‚“ã«ã¡ã¯ã€${escapeHtml(state.nickname)}ã•ã‚“ï¼ä»Šæ—¥ã¯20ã®è³ªå•ã§æ€§æ ¼ã®å‚¾å‘ã‚’è¦‹ã¦ã„ãã‚ˆã€‚æ°—æ¥½ã«ã„ã“ã†ã€‚`, "ai");
    speak(`ã“ã‚“ã«ã¡ã¯ã€${state.nickname}ã•ã‚“ã€‚ä»Šæ—¥ã¯20ã®è³ªå•ã§æ€§æ ¼ã®å‚¾å‘ã‚’è¦‹ã¦ã„ãã‚ˆã€‚æ°—æ¥½ã«ã„ã“ã†ã€‚`);
    askCurrentQuestion();
    updateControls();
  }

  function submitAnswer(answerRaw, skipped=false){
    if(!state.started || state.finished) return;

    const answer = (answerRaw || "").trim();
    if(!skipped && !answer){
      addSystemBubble("å›ç­”ãŒç©ºã¿ãŸã„ã€‚çŸ­ãã¦ã‚‚OKã ã‚ˆã€‚");
      speak("å›ç­”ãŒç©ºã¿ãŸã„ã€‚çŸ­ãã¦ã‚‚OKã ã‚ˆã€‚");
      return;
    }

    // store
    const stored = skipped ? "ï¼ˆã‚¹ã‚­ãƒƒãƒ—ï¼‰" : answer;
    state.answers.push(stored);

    // show user bubble
    addBubble(skipped ? "ï¼ˆã‚¹ã‚­ãƒƒãƒ—ï¼‰" : escapeHtml(answer), "me");

    // aizuuchi + simple impression
    const a = randomPick(AIZUCHI);
    const imp = skipped ? "OKã€é£›ã°ã—ã¦æ¬¡ã¸ã„ã“ã†ã€‚" : shortImpression(answer);
    const reply = `${a} ${imp}`;
    addBubble(reply, "ai");
    speak(reply);

    // next
    state.qIndex++;
    updateProgress();

    if(state.qIndex >= QUESTIONS.length){
      finishSession();
    } else {
      askCurrentQuestion();
    }
    updateControls();
  }

  function finishSession(){
    state.finished = true;
    setStatus("20å• å®Œäº†ï¼", "ok");
    el.resultTag.textContent = "ä½œæˆå®Œäº†";
    el.resultTag.style.background = "rgba(31,191,117,.12)";
    el.resultTag.style.borderColor = "rgba(31,191,117,.22)";
    el.resultTag.style.color = "#0b5c35";

    stopListening();

    addBubble("ãŠã¤ã‹ã‚Œã•ã¾ï¼ã“ã“ã¾ã§ã®å›ç­”ã‹ã‚‰ã€7é …ç›®ã§ç·åˆè©•ä¾¡ã—ã¦ã¿ã‚‹ã­ã€‚", "ai");
    speak("ãŠã¤ã‹ã‚Œã•ã¾ï¼ã“ã“ã¾ã§ã®å›ç­”ã‹ã‚‰ã€7é …ç›®ã§ç·åˆè©•ä¾¡ã—ã¦ã¿ã‚‹ã­ã€‚");

    const scores = computeTraitScores(state.answers);
    drawRadar(scores);
    renderResults(scores);

    el.sendBtn.disabled = true;
    el.skipBtn.disabled = true;
  }

  function renderResults(scores){
    el.resultArea.innerHTML = "";

    const topKey = Object.keys(scores).sort((a,b)=>scores[b]-scores[a])[0];
    const lowKey = Object.keys(scores).sort((a,b)=>scores[a]-scores[b])[0];

    const summary = document.createElement("div");
    summary.className = "oknotice";
    summary.innerHTML = `
      <b>${escapeHtml(state.nickname)}ã•ã‚“ã®ç·åˆå‚¾å‘</b><br/>
      å¼·ã¿ã¯ã€Œ${labelOf(topKey)}ã€ãŒå‡ºã‚„ã™ã„ã€‚ä¼¸ã³ã—ã‚ã¯ã€Œ${labelOf(lowKey)}ã€ã€‚<br/>
      â€»ã“ã‚Œã¯å›ç­”å†…å®¹ã®è¨€è‘‰ã¥ã‹ã„ãƒ»ä¾¡å€¤è¦³ãƒ»è¡Œå‹•å‚¾å‘ã‹ã‚‰ã®â€œæ€§æ ¼å‚¾å‘â€ã§ã™ã€‚
    `;
    el.resultArea.appendChild(summary);

    // Per-trait evaluations (<=100 chars) + advice
    for(const t of TRAITS){
      const s = scores[t.key];
      const evalText = cap100(evaluationText(t.label, s));
      const adv = adviceText(t.key, s);

      const row = document.createElement("div");
      row.className = "scoreRow";
      row.innerHTML = `
        <div>
          <b>${t.label}</b>
          <div class="small" style="margin-top:6px;">
            <span class="tag" style="margin-right:8px;">${s}</span>
            <span>${escapeHtml(evalText)}</span>
            <div class="divider"></div>
            <span><b>ã‚¢ãƒ‰ãƒã‚¤ã‚¹ï¼š</b>${escapeHtml(adv)}</span>
          </div>
        </div>
        <div class="s">/100</div>
      `;
      el.resultArea.appendChild(row);
    }

    const end = document.createElement("div");
    end.className = "notice";
    end.innerHTML = `æ¬¡ã«ã‚„ã‚‹ãªã‚‰ï¼šä¸€ç•ªä½ã„é …ç›®ã‚’â€œ1ã¤ã ã‘â€åº•ä¸Šã’ã™ã‚‹ã¨å…¨ä½“ãŒæ•´ã„ã‚„ã™ã„ã‚ˆã€‚`;
    el.resultArea.appendChild(end);
  }

  function labelOf(key){
    const t = TRAITS.find(x=>x.key===key);
    return t ? t.label : key;
  }

  function cap100(str){
    // Ensure <= 100 Japanese chars-ish (count as code points)
    const arr = Array.from(str);
    if(arr.length <= 100) return str;
    return arr.slice(0, 98).join("") + "â€¦";
  }

  function escapeHtml(s){
    return s
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function resetAll(){
    stopListening();
    state.started = false;
    state.finished = false;
    state.qIndex = 0;
    state.answers = [];
    el.chat.innerHTML = "";
    el.answerText.value = "";
    el.readyNotice.style.display = "block";
    setStatus("æº–å‚™ä¸­", "normal");
    el.resultTag.textContent = "æœªä½œæˆ";
    el.resultTag.style.background = "rgba(255,122,89,.10)";
    el.resultTag.style.borderColor = "rgba(255,122,89,.18)";
    el.resultTag.style.color = "var(--accent2)";
    el.resultArea.innerHTML = `<div class="small">20å•å›ç­”ã™ã‚‹ã¨ã€7é …ç›®ã®è©•ä¾¡ï¼ˆå„100æ–‡å­—ä»¥å†…ï¼‰ã¨ã‚¢ãƒ‰ãƒã‚¤ã‚¹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>`;
    drawRadar({
      motivation:50,business:50,love:50,communication:50,creativity:50,resilience:50,balance:50
    });
    updateProgress();
    updateControls();
  }

  // -----------------------------
  // Events
  // -----------------------------
  el.mode.addEventListener("change", () => {
    state.inputMode = el.mode.value;
    updateVoiceButtons();
    if(state.inputMode !== "voice") stopListening();
    addSystemBubble(`å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ï¼š${state.inputMode === "voice" ? "éŸ³å£°" : "ãƒ†ã‚­ã‚¹ãƒˆ"} ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸã€‚`);
  });

  el.speak.addEventListener("change", () => {
    state.speak = el.speak.checked;
    addSystemBubble(`èª­ã¿ä¸Šã’ï¼š${state.speak ? "ON" : "OFF"} ã«ã—ã¾ã—ãŸã€‚`);
  });

  el.startBtn.addEventListener("click", startSession);

  el.sendBtn.addEventListener("click", () => {
    submitAnswer(el.answerText.value, false);
  });

  el.skipBtn.addEventListener("click", () => {
    submitAnswer("", true);
  });

  el.resetBtn.addEventListener("click", () => {
    resetAll();
    addSystemBubble("ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚æœ€åˆã‹ã‚‰å§‹ã‚ã‚‰ã‚Œã¾ã™ã€‚");
  });

  el.answerText.addEventListener("input", updateSendEnabled);

  el.listenBtn.addEventListener("click", () => {
    if(!state.started){
      addSystemBubble("å…ˆã«ã€Œé–‹å§‹ã€ã‚’æŠ¼ã—ã¦ã­ã€‚");
      speak("å…ˆã«é–‹å§‹ã‚’æŠ¼ã—ã¦ã­ã€‚");
      return;
    }
    startListening();
  });

  el.stopBtn.addEventListener("click", stopListening);

  // Enter to send (Ctrl+Enter)
  el.answerText.addEventListener("keydown", (e) => {
    if(e.key === "Enter" && (e.ctrlKey || e.metaKey)){
      e.preventDefault();
      if(!el.sendBtn.disabled) el.sendBtn.click();
    }
  });

  // Init
  state.inputMode = el.mode.value;
  state.speak = el.speak.checked;

  if(!canUseVoice()){
    // voice not available
    el.mode.querySelector('option[value="voice"]').disabled = true;
    addSystemBubble("ã“ã®ç’°å¢ƒã§ã¯éŸ³å£°å…¥åŠ›ãŒä½¿ãˆãªã„ãŸã‚ã€ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã§ã”åˆ©ç”¨ãã ã•ã„ã€‚");
  }
  updateVoiceButtons();
  resetAll();

})();
</script>

<script>
  // PWA: service worker registration
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js").catch(console.warn);
    });
  }
</script>

</body>
</html>
